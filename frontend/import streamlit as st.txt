import streamlit as st
import requests
import json
import time
import datetime
import uuid
from datetime import datetime
import chardet
import os
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()



# åç«¯APIåœ°å€
BACKEND_URL = "http://localhost:8000/api"

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(
    page_title="Gridseek", 
    layout="wide",  # ä½¿ç”¨å®½å±å¸ƒå±€
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSSæ ·å¼
st.markdown("""
<style>
    /* ç°è‰²ä¾§è¾¹æ ä¸»é¢˜ */
    .css-1d391kg {
        background-color: #8B5CF6;
    }
    
    /* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
    .main .block-container {
        padding-top: 1rem;
        padding-bottom: 1rem;
        max-width: 100% !important;
    }
    
    /* å¯¹è¯å†å²å®¹å™¨æ ·å¼ */
    .chat-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 10px;
        border-left: 4px solid #8B5CF6;
    }
    
    /* ç”¨æˆ·æ¶ˆæ¯æ ·å¼ */
    .user-message {
        background-color: #e3f2fd;
        padding: 10px 15px;
        border-radius: 15px 15px 15px 5px;
        margin: 5px 0;
        border: 1px solid #bbdefb;
    }
    
    /* LLMæ¶ˆæ¯æ ·å¼ */
    .llm-message {
        background-color: #f3e5f5;
        padding: 10px 15px;
        border-radius: 15px 15px 5px 15px;
        margin: 5px 0;
        border: 1px solid #e1bee7;
    }
    
    /* ä¸‰å…ƒç»„ç»“æœæ ·å¼ */
    .triplet-result {
        background-color: #fff3e0;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #ffcc80;
    }
    
    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .graph-container {
        background-color: white;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 600px;
    }
    
    /* è®¾ç½®å¯¹è¯åŒºåŸŸçš„å›ºå®šé«˜åº¦å’Œæ»šåŠ¨ */
    [data-testid="column"]:first-child {
        height: 600px;
        overflow: hidden;
    }
    
    /* è®¾ç½®æ¶ˆæ¯å®¹å™¨çš„æ ·å¼ */
    .stChatMessageContainer {
        height: calc(100vh - 200px) !important;
        overflow-y: auto !important;
        padding-bottom: 100px;
    }
    
    /* å›ºå®šè¾“å…¥æ¡†åœ¨åº•éƒ¨ */
    .input-container {
        position: fixed;
        bottom: 0;
        left: 18rem;  /* ä¾§è¾¹æ å®½åº¦ */
        right: 0;
        background: white;
        padding: 1rem;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    /* è°ƒæ•´è¾“å…¥æ¡†æ ·å¼ */
    .input-container .stTextInput {
        margin-bottom: 0;
    }
    
    /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
    .chat-message {
        display: flex;
        margin: 8px 0;
        padding: 0 20px;
    }
    
    .chat-message.user {
        justify-content: flex-end;
    }
    
    .chat-message.ai {
        justify-content: flex-start;
    }
    
    .bubble-user {
        background: #a5d6fa;
        color: #222;
        border-radius: 18px 6px 18px 18px;
        padding: 12px 18px;
        margin-right: 40px;
        max-width: 70%;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }
    
    .bubble-ai {
        background: #f3e5f5;
        color: #222;
        border-radius: 6px 18px 18px 18px;
        padding: 12px 18px;
        margin-left: 40px;
        max-width: 70%;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }
    
    .avatar-user {
        position: absolute;
        right: -38px;
        top: 0;
        font-size: 28px;
    }
    
    .avatar-ai {
        position: absolute;
        left: -38px;
        top: 0;
        font-size: 28px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
""", unsafe_allow_html=True)

# æ–‡ä»¶è·¯å¾„ç”¨äºä¿å­˜èŠå¤©å†å²
CHAT_HISTORY_FILE = "chat_history.json"

# åˆå§‹åŒ–æ‰€æœ‰session_stateå˜é‡
if "history" not in st.session_state:
    st.session_state["history"] = []  # å¯¹è¯å†å²
if "conversations" not in st.session_state:
    st.session_state["conversations"] = {}  # å­˜å‚¨æ‰€æœ‰å¯¹è¯
if "current_conversation_id" not in st.session_state:
    st.session_state["current_conversation_id"] = None  # å½“å‰æ´»è·ƒå¯¹è¯ID
if "triplets" not in st.session_state:
    st.session_state["triplets"] = None  # ä¸‰å…ƒç»„å¯¹è±¡
if "extract_index" not in st.session_state:
    st.session_state["extract_index"] = None
if "current_response" not in st.session_state:
    st.session_state["current_response"] = None  # æœ€è¿‘ä¸€æ¬¡å›å¤
if 'prompts' not in st.session_state:
    st.session_state['prompts'] = [{"role": "system"}]
if 'past' not in st.session_state:
    st.session_state['past'] = []
if 'generated' not in st.session_state:
    st.session_state['generated'] = []
if 'chat_sessions' not in st.session_state:
    st.session_state['chat_sessions'] = {}  # å­˜å‚¨æ‰€æœ‰èŠå¤©ä¼šè¯
if 'current_session' not in st.session_state:
    st.session_state['current_session'] = None  # å½“å‰ä¼šè¯

# åŠ è½½å†å²å¯¹è¯
def load_chat_history():
    try:
        with open(CHAT_HISTORY_FILE, "r", encoding="utf-8") as f:
            st.session_state['chat_sessions'] = json.load(f)
    except UnicodeDecodeError:
        try:
            with open(CHAT_HISTORY_FILE, "rb") as f:
                raw_data = f.read()
                encoding = chardet.detect(raw_data)["encoding"] or "latin1"
            with open(CHAT_HISTORY_FILE, "r", encoding=encoding) as f:
                st.session_state['chat_sessions'] = json.load(f)
        except Exception as e:
            st.warning(f"æ— æ³•åŠ è½½èŠå¤©å†å²ï¼š{str(e)}ï¼Œåˆå§‹åŒ–ä¸ºç©º")
            st.session_state['chat_sessions'] = {}
    except FileNotFoundError:
        st.session_state['chat_sessions'] = {}

# ä¿å­˜å†å²å¯¹è¯åˆ°æ–‡ä»¶
def save_chat_history():
    try:
        with open(CHAT_HISTORY_FILE, "w", encoding="utf-8") as f:
            json.dump(st.session_state['chat_sessions'], f, ensure_ascii=False, indent=2)
    except Exception as e:
        st.error(f"ä¿å­˜èŠå¤©å†å²å¤±è´¥ï¼š{str(e)}")

def generate_response(prompt):
    """é€šè¿‡åç«¯APIè·å–å›å¤"""
    try:
        # å‡†å¤‡è¯·æ±‚æ•°æ®
        data = {
            "question": prompt,
            "system_prompt": st.session_state.prompts[0].get("content", "")
        }
        
        # å‘é€POSTè¯·æ±‚åˆ°åç«¯
        response = requests.post(f"{BACKEND_URL}/qa", json=data)
        
        # æ‰“å°è°ƒè¯•ä¿¡æ¯
        print(f"å‘é€è¯·æ±‚åˆ°: {BACKEND_URL}/qa")
        print(f"è¯·æ±‚æ•°æ®: {data}")
        print(f"å“åº”çŠ¶æ€ç : {response.status_code}")
        
        try:
            print(f"å“åº”å†…å®¹: {response.json()}")
        except:
            print(f"å“åº”æ–‡æœ¬: {response.text}")
        
        response.raise_for_status()  # æ£€æŸ¥å“åº”çŠ¶æ€
        
        # è§£æå“åº”
        result = response.json()
        return result["answer"]
    except requests.exceptions.RequestException as e:
        error_msg = f"APIè¯·æ±‚é”™è¯¯: {str(e)}"
        print(error_msg)  # æ‰“å°åˆ°æ§åˆ¶å°
        st.error(error_msg)  # æ˜¾ç¤ºåœ¨UIä¸Š
        return None

# åˆ›å»ºæ–°ä¼šè¯
def create_new_session():
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    session_id = f"æ–°ä¼šè¯_{timestamp}"  # é»˜è®¤åç§°
    st.session_state['chat_sessions'][session_id] = {
        "prompts": [{"role": "system"}],
        "past": [],
        "generated": []
    }
    st.session_state['current_session'] = session_id
    st.session_state['prompts'] = [{"role": "system"}]
    st.session_state['past'] = []
    st.session_state['generated'] = []
    save_chat_history()

# åŠ è½½å†å²ä¼šè¯
def load_session(session_id):
    if session_id in st.session_state['chat_sessions']:
        st.session_state['current_session'] = session_id
        st.session_state['prompts'] = st.session_state['chat_sessions'][session_id]["prompts"]
        st.session_state['past'] = st.session_state['chat_sessions'][session_id]["past"]
        st.session_state['generated'] = st.session_state['chat_sessions'][session_id]["generated"]

# æ¸…ç©ºå½“å‰ä¼šè¯
def clear_chat():
    if st.session_state['current_session']:
        st.session_state['chat_sessions'][st.session_state['current_session']] = {
            "prompts": [{"role": "system", }],
            "past": [],
            "generated": []
        }
        load_session(st.session_state['current_session'])
        save_chat_history()

# å¤„ç†ç”¨æˆ·å‘é€æ¶ˆæ¯
def chat_click():
    """å¤„ç†æ¶ˆæ¯å‘é€çš„å›è°ƒå‡½æ•°"""
    if "user_input_key" in st.session_state and st.session_state['current_session']:
        user_input = st.session_state.user_input_key
        if not user_input.strip():
            return
            
        try:
            # å…ˆå°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
            st.session_state['past'].append(user_input)
            
            # å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œç”¨å®ƒæ¥é‡å‘½åä¼šè¯
            if len(st.session_state['past']) == 1:
                old_session_id = st.session_state['current_session']
                new_session_id = user_input[:20] + "..." if len(user_input) > 20 else user_input
                
                # æ›´æ–°ä¼šè¯ID
                st.session_state['chat_sessions'][new_session_id] = st.session_state['chat_sessions'].pop(old_session_id)
                st.session_state['current_session'] = new_session_id
            
            # è·å–AIå›å¤
            output = generate_response(user_input)
            if output:
                st.session_state['generated'].append(output)
                st.session_state['prompts'].append({"role": "assistant", "content": output})
                
                # æ›´æ–°å½“å‰ä¼šè¯çš„å­˜å‚¨
                st.session_state['chat_sessions'][st.session_state['current_session']] = {
                    "prompts": st.session_state['prompts'],
                    "past": st.session_state['past'],
                    "generated": st.session_state['generated']
                }
                
                # ä¿å­˜èŠå¤©å†å²
                save_chat_history()
                print("Message processed successfully")
            else:
                print("Warning: Empty response from AI")
                st.error("æœªèƒ½è·å–åˆ°AIçš„å›å¤ï¼Œè¯·é‡è¯•")
            
            # æ¸…ç©ºè¾“å…¥æ¡†
            st.session_state.user_input_key = ""
            
        except Exception as e:
            print(f"Error processing message: {str(e)}")
            st.error(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")

# åˆå§‹åŒ–åŠ è½½å†å²è®°å½•
load_chat_history()

st.title("Gridseek")

# ä¾§è¾¹æ è®¾ç½®
with st.sidebar:
    st.markdown("### ğŸ›ï¸ ç³»ç»Ÿè®¾ç½®")
    try:
        prompt_resp = requests.get(f"{BACKEND_URL}/prompt/")
        default_prompt = prompt_resp.json().get("system_prompt", "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½é—®ç­”åŠ©æ‰‹,èƒ½å¤Ÿä½¿ç”¨å»ºç®€ç‚¼æœ‰æ•ˆçš„è¯­è¨€è§£å†³ç›¸å…³çš„é—®é¢˜")
    except:
        default_prompt = "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½é—®ç­”åŠ©æ‰‹,èƒ½å¤Ÿä½¿ç”¨å»ºç®€ç‚¼æœ‰æ•ˆçš„è¯­è¨€è§£å†³ç›¸å…³çš„é—®é¢˜"
    
    system_prompt = st.text_area("ç³»ç»Ÿ Prompt", value=default_prompt, height=120)
    
    if st.button("ğŸ”„ æ›´æ–° Prompt"):
        try:
            resp = requests.post(f"{BACKEND_URL}/prompt/", json={"prompt": system_prompt})
            if resp.ok:
                st.success("âœ… ç³»ç»Ÿ Prompt å·²æ›´æ–°ï¼")
            else:
                st.error("âŒ æ›´æ–°å¤±è´¥")
        except Exception as e:
            st.error(f"âŒ æ›´æ–°å¤±è´¥: {str(e)}")
    
    st.markdown("---")
    st.markdown("### ğŸ“Š èŠå¤©å†å²")
    
    if st.button("æ–°å»ºä¼šè¯"):
        create_new_session()
    
    # æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯æ ‡é¢˜
    for session_id in st.session_state['chat_sessions']:
        if st.button(session_id, key=f"session_{session_id}"):
                          load_session(session_id)


# æ›´æ–°CSSæ ·å¼ï¼Œç¡®ä¿æ¶ˆæ¯å®¹å™¨å›ºå®šé«˜åº¦å¹¶æ­£ç¡®æ»šåŠ¨
st.markdown("""
<style>
    /* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
    .main .block-container {
        padding-top: 1rem;
        padding-bottom: 1rem;
        max-width: 100% !important;
    }

    /* å·¦ä¾§èŠå¤©åŒºåŸŸæ•´ä½“å®¹å™¨ */
    .chat-area-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px) !important;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* èŠå¤©æ ‡é¢˜æ ·å¼ */
    .chat-title {
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e8eaed;
        font-weight: 600;
        font-size: 1.2rem;
    }
    
    /* æ¶ˆæ¯å®¹å™¨ - å›ºå®šé«˜åº¦å¹¶æ·»åŠ æ»šåŠ¨æ¡ */
    .message-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .message-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .message-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .message-container::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 4px;
    }
    
    .message-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* è¾“å…¥åŒºåŸŸå®¹å™¨ */
    .input-container {
        padding: 15px;
        background: #f8f9fa;
        border-top: 1px solid #e8eaed;
    }

    /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
    .chat-message {
        margin: 8px 0;
    }

    .chat-message.user {
        display: flex;
        justify-content: flex-end;
    }

    .chat-message.ai {
        display: flex;
        justify-content: flex-start;
    }

    .bubble-user {
        background: #a5d6fa;
        color: #222;
        border-radius: 18px 6px 18px 18px;
        padding: 12px 18px;
        margin-right: 40px;
        max-width: 70%;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }

    .bubble-ai {
        background: #f3e5f5;
        color: #222;
        border-radius: 6px 18px 18px 18px;
        padding: 12px 18px;
        margin-left: 40px;
        max-width: 70%;
        position: relative;
        animation: fadeIn 0.3s ease-out;
    }

    .avatar-user {
        position: absolute;
        right: -38px;
        top: 0;
        font-size: 28px;
    }

    .avatar-ai {
        position: absolute;
        left: -38px;
        top: 0;
        font-size: 28px;
    }

    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .graph-container {
        height: calc(100vh - 100px) !important;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
""", unsafe_allow_html=True)

# åˆ›å»ºå·¦å³åˆ†æ  - è°ƒæ•´æ¯”ä¾‹
left_col, right_col = st.columns([5, 5])  # 5:5çš„æ¯”ä¾‹

# å·¦ä¾§æ  - èŠå¤©åŒºåŸŸ
with left_col:
    # åˆ›å»ºæ•´ä½“èŠå¤©åŒºåŸŸå®¹å™¨
    st.markdown('<div class="chat-area-container">', unsafe_allow_html=True)
    
    # èŠå¤©æ ‡é¢˜
    if st.session_state['current_session']:
        st.markdown(f'<div class="chat-title">å½“å‰ä¼šè¯ï¼š{st.session_state["current_session"]}</div>', unsafe_allow_html=True)
    else:
        st.markdown('<div class="chat-title">è¯·åœ¨ä¾§è¾¹æ æ–°å»ºæˆ–é€‰æ‹©ä¸€ä¸ªä¼šè¯</div>', unsafe_allow_html=True)
    
    # åˆ›å»ºæ¶ˆæ¯å®¹å™¨ - å›ºå®šé«˜åº¦å¹¶æ”¯æŒæ»šåŠ¨
    st.markdown('<div class="message-container">', unsafe_allow_html=True)
    
    # æ˜¾ç¤ºèŠå¤©è®°å½•
    if st.session_state['current_session']:
        for i in range(len(st.session_state['past'])):
            # æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            st.markdown(
                f"""
                <div class="chat-message user">
                    <div class="bubble-user">
                        {st.session_state['past'][i]}
                        <span class="avatar-user">ğŸ‘¤</span>
                    </div>
                </div>
                """, 
                unsafe_allow_html=True
            )
            
            # æ˜¾ç¤ºAIå›å¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if i < len(st.session_state['generated']):
                st.markdown(
                    f"""
                    <div class="chat-message ai">
                        <div class="bubble-ai">
                            {st.session_state['generated'][i]}
                            <span class="avatar-ai">ğŸ¤–</span>
                        </div>
                    </div>
                    """, 
                    unsafe_allow_html=True
                )
    
    st.markdown('</div>', unsafe_allow_html=True)  # ç»“æŸæ¶ˆæ¯å®¹å™¨
    
    # è¾“å…¥åŒºåŸŸ
    st.markdown('<div class="input-container">', unsafe_allow_html=True)
    col1, col2 = st.columns([4, 1])
    with col1:
        user_input = st.text_input("", 
                                placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜...", 
                                label_visibility="collapsed",
                                key="user_input_key",
                                on_change=chat_click,
                                disabled=not st.session_state['current_session'])
    with col2:
        if st.button("å‘é€", 
                use_container_width=True,
                disabled=not st.session_state['current_session']):
            chat_click()
    st.markdown('</div>', unsafe_allow_html=True)  # ç»“æŸè¾“å…¥å®¹å™¨
    
    st.markdown('</div>', unsafe_allow_html=True)  # ç»“æŸæ•´ä½“èŠå¤©åŒºåŸŸå®¹å™¨

# å³ä¾§æ  - çŸ¥è¯†å›¾è°±å±•ç¤ºåŒºåŸŸ
with right_col:
    st.markdown("### çŸ¥è¯†å›¾è°±")
    # ä½¿ç”¨iframeåµŒå…¥graph.html
    with open("graph.html", "r", encoding="utf-8") as f:
        graph_html = f.read()
    
    # ä½¿ç”¨components.htmlåµŒå…¥
    st.components.v1.html(
        f"""
        <div class="graph-container">
            {graph_html}
        </div>
        """, 
        height=650
    )


# æ¸…ç©ºä¼šè¯æŒ‰é’®
st.button(
    "æ¸…ç©ºå½“å‰ä¼šè¯",
    on_click=clear_chat,
    disabled=not st.session_state.current_session
)

def on_send_message():
    """å¤„ç†æ¶ˆæ¯å‘é€çš„å›è°ƒå‡½æ•°"""
    if st.session_state.user_input and st.session_state.current_session:
        user_input = st.session_state.user_input
        
        try:
            print("å¼€å§‹å¤„ç†æ–°æ¶ˆæ¯...")
            print(f"ç”¨æˆ·è¾“å…¥: {user_input}")
            print(f"å½“å‰ä¼šè¯çŠ¶æ€ - past: {st.session_state.past}")
            print(f"å½“å‰ä¼šè¯çŠ¶æ€ - generated: {st.session_state.generated}")
            
            # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
            st.session_state.past.append(user_input)
            
            # è·å–AIå›å¤
            output = generate_response(user_input)
            print(f"AIå›å¤: {output}")
            
            if output:
                # æ›´æ–°ä¼šè¯çŠ¶æ€
                st.session_state.generated.append(output)
                st.session_state.prompts.append({"role": "assistant", "content": output})
                
                # æ›´æ–°å½“å‰ä¼šè¯çš„å­˜å‚¨
                st.session_state.chat_sessions[st.session_state.current_session] = {
                    "prompts": st.session_state.prompts,
                    "past": st.session_state.past,
                    "generated": st.session_state.generated
                }
                
                # ä¿å­˜èŠå¤©å†å²
                save_chat_history()
                print("æ¶ˆæ¯å¤„ç†å®Œæˆï¼Œå·²æ›´æ–°ä¼šè¯çŠ¶æ€")
            else:
                print("è­¦å‘Šï¼šAIå›å¤ä¸ºç©º")
                st.error("æœªèƒ½è·å–åˆ°AIçš„å›å¤ï¼Œè¯·é‡è¯•")
            
        except Exception as e:
            print(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")
            st.error(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {str(e)}")
        
        # æ¸…ç©ºè¾“å…¥æ¡†
        st.session_state.user_input = ""
        
        # å¼ºåˆ¶é‡æ–°æ¸²æŸ“
        st.rerun() 